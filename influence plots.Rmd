---
title: "Influence effects"
date: "Last compiled on `r format(Sys.time(), '%B, %Y')`"
bibliography: references.bib
output:
  html_document:
    css: tweaks.css
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    code_folding: show
    code_download: yes
---

```{r, globalsettings, echo=FALSE, warning=FALSE}
library(knitr)
library(RSiena)
library(ggplot2)
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test2"))
options(width = 100)
rgl::setupKnitr()

colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x) }

```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```

<br>

---

We will show how the influence statistics in RSiena behave. 
We assume that ego is connected to all alters. 

<br>

## Functions

First, we define some functions:

<br>

### Centering behavior variables
```{r}
fcentering <- function(actors){
centered <- actors - mean(actors)
return(centered)
}
```

### Calculating similarity scores

$$ sim^z_{ij} = 1 - \frac{|z_i - z_j|}{r_V} $$
```{r}
fsimij <- function(actors, min, max){
#rv <- max(actors) - min(actors)
rv <- max - min
mat1 <- matrix(actors, nrow=length(actors), ncol=length(actors), byrow=TRUE)
mat2 <- t(mat1)
simij <- 1 - ( abs(mat1-mat2) / rv)
return(simij)
}
```

### The average similarity effect (avSim)

$$ s^{beh}_{i5}(x,z) = x^{-1}_{i+}\sum_j x_{ij}(sim^z_{ij} - \widehat{sim^z}) $$
```{r}
favSim <- function(ego, alters, min, max) {
  actors <- c(ego,alters) #define the network
  beh_centered <- fcentering(actors) #center behavior scores
  simij <- fsimij(beh_centered, min, max) #calculate the similarity scores
  diag(simij) <- NA
  msimij <- mean(simij, na.rm=TRUE) #calculate the mean similarity score. only calculate mean on non-diagonal cells??!!
  simij_c <- simij - msimij #center the similarity scores
  
  statistic <- sum(simij_c[1,], na.rm = TRUE) / length(alters) #the actual statistic
  
  return(statistic)
}
```

```{r}
favSim2 <- function(ego, alters, min, max) {
  actors <- c(ego,alters) #define the network
  beh_centered <- fcentering(actors) #center behavior scores
  simij <- fsimij(beh_centered, min, max) #calculate the similarity scores
  diag(simij) <- NA
  #msimij <- mean(simij, na.rm=TRUE) #calculate the mean similarity score. only calculate mean on non-diagonal cells??!!
  simij_c <- simij # here we do not center the similarity
  
  statistic <- sum(simij_c[1,], na.rm = TRUE) / length(alters) #the actual statistic
  
  return(statistic)
}
```

### The average attraction towards higher effect (avAttHigher)

$$ s^{beh}_{i23}(x,z) = x^{-1}_{i+}\sum_j x_{ij} (\, I \{ (z_j)>z_i \} sim^z_{ij} + I \{ (z_j ) \le z_i \} )\,$$
```{r}
favAttHigher <- function(ego, alters, min, max) {
  actors <- c(ego,alters)
  beh_centered <- fcentering(actors)
  simij <- fsimij(beh_centered, min, max)
  diag(simij) <- NA
  
  simijH <- simij[1,]
  simijH[beh_centered <= beh_centered[1]] <- 1
  simijH[1] <- NA
  statistic <- sum(simijH, na.rm = TRUE) / length(alters)
  
 
  return(statistic)
}
```

### The average attraction towards higher alters effect (avAttLower)

$$ s^{beh}_{i24}(x,z) = x^{-1}_{i+}\sum_j x_{ij} (\, I \{ (z_j)<z_i \} sim^z_{ij} + I \{ (z_j ) \ge z_i \} )\,$$
```{r}
favAttLower <- function(ego, alters, min, max) {
  actors <- c(ego,alters)
  beh_centered <- fcentering(actors)
  simij <- fsimij(beh_centered, min, max)
  diag(simij) <- NA
  
  simijL <- simij[1,]
  simijL[beh_centered >= beh_centered[1]] <- 1
  simijL[1] <- NA
  statistic <- sum(simijL, na.rm = TRUE) / length(alters)
  
 
  return(statistic)
}
```

### Average alter effect (avAlt)

$$ s^{beh}_{i27}(x,z) = z_i(\textstyle \sum_jx_{ij}z_j)/(\textstyle \sum_jx_{ij}) $$ 

```{r}
favAlt <- function(ego, alters, ...) {
  actors <- c(ego,alters)
  beh_centered <- fcentering(actors)
  
  statistic <- beh_centered[1] * (sum(beh_centered[-1], na.rm = TRUE) / length(alters))
  
 
  return(statistic)
}
```

### Average attraction mean alters (avAtt)

```{r}
fAttMean <- function(ego, alters, min, max, ...) {
  rv <- max - min
  actors <- c(ego,alters)
  beh_centered <- fcentering(actors)
  
  statistic <- 1 -  abs(beh_centered[1] - (sum(beh_centered[-1], na.rm = TRUE) / length(alters)))/rv #thus we strive for a highest local similarity score!
  
 
  return(statistic)
}
```

----

<br> 

## Make plot of statistic values {.tabset .tabset-fade}

Jochem's functions

```{r}
finfluenceplot <- function(alters, min, max, fun) {
  name <- deparse(substitute(fun))
  s <- NA
  for (i in min:max) {
    s[i] <- fun(i, alters, min, max)
  }
    {
      plot(y=s, x=min:max, xlab="ego behavioral score", ylab=name, ylim=c(-1,1), type="b")
      mtext(paste("alters:", paste0(alters, collapse=",")))
    }
}

finfluenceplot2 <- function(alters, min, max, fun) {
  s <- NA
  for (i in min:max) {
    s[i] <- 0
    for (j in 1:length(fun)) {
      s[i] <- s[i] + fun[[j]](i, alters, min, max)      
    }
  }
    {
      name <- deparse(substitute(fun))
      #name <- stringr::str_remove(as.character(name), "list")
      name <- stringr::str_sub(as.character(name), 6, -2)
      plot(y=s, x=min:max, xlab="ego behavioral score", ylab=name, type="b")
      mtext(paste("alters:", paste0(alters, collapse=",")))
    }
}
```

### example

```{r}
alters1 <- rep(c(3,3,3,3,3,3),1)
finluenceplot(alters=alters1, min=1, max=6, favSim)

```



```{r class.source = 'fold-hide', eval=F}
rv <- 6
size <- 6

# alter behavior 1:6
alters <- list()
for (zj in 1:rv) {
  alters[[zj]] <- rep(zj, size)
}

# we caclulate avSim statistic, considering z_i and z_j:
(s_avSim <- array(dim = c(rv,rv)))
for (zj in 1:rv) {
  for (zi in 1:rv) {
    s_avSim[zi,zj] <- favSim(zi, alters[[zj]])
  }
} # rows refer to ego's prospective behavior (zi); columns refer to alter average (zj)

# turn it into a dataframe
df <- data.frame(zi = rep(1:rv, rv),
                   s = c(s_avSim[,1], s_avSim[,2], s_avSim[,3], s_avSim[,4], s_avSim[,5], s_avSim[,6] ),
                   zj = as.character(rep(1:rv, each=rv)))

s_avSim


# we do the same for the avAttHigh statistic
(s_avSimH <- array(dim = c(rv,rv)))
for (zj in 1:rv) {
  for (zi in 1:rv) {
    s_avSimH[zi,zj] <- favSimH(zi, alters[[zj]])
  }
} 
df2 <- data.frame(zi = rep(1:rv, rv),
                   s = c(s_avSimH[,1], s_avSimH[,2], s_avSimH[,3], s_avSimH[,4], s_avSimH[,5], s_avSimH[,6] ),
                   zj = as.character(rep(1:rv, each=rv)))

# for avAttLow
(s_avSimL <- array(dim = c(rv,rv)))
for (zj in 1:rv) {
  for (zi in 1:rv) {
    s_avSimL[zi,zj] <- favSimL(zi, alters[[zj]])
  }
} 
df3 <- data.frame(zi = rep(1:rv, rv),
                   s = c(s_avSimL[,1], s_avSimL[,2], s_avSimL[,3], s_avSimL[,4], s_avSimL[,5], s_avSimL[,6] ),
                   zj = as.character(rep(1:rv, each=rv)))

# and for avAttHigh+Low
(s_avSimHL <- array(dim = c(rv,rv)))
for (zj in 1:rv) {
  for (zi in 1:rv) {
    s_avSimHL[zi,zj] <- favSimH(zi, alters[[zj]]) + favSimL(zi, alters[[zj]])
  }
} 
df4 <- data.frame(zi = rep(1:rv, rv),
                   s = c(s_avSimHL[,1], s_avSimHL[,2], s_avSimHL[,3], s_avSimHL[,4], s_avSimHL[,5], s_avSimHL[,6] ),
                  zj = as.character(rep(1:rv, each=rv)))
 
ggplot(data=df, aes(x=zi, y=s)) + 
  geom_line(aes(colour=zj)) +
  ylab("avSim statistic") +
  xlab("ego score z_i") + 
  scale_colour_hue(name="alter score z_j")
ggsave("avSim.png", path = "images/influence plots", width = 6, height = 3)

ggplot(data=df2, aes(x=zi, y=s)) + 
  geom_line(aes(colour=zj)) +
  ylab("avAttHigher statistic") +
  xlab("ego score z_i") + 
  scale_colour_hue(name="alter score z_j")
ggsave("avSimH.png", path = "images/influence plots", width = 6, height = 3)

ggplot(data=df3, aes(x=zi, y=s)) + 
  geom_line(aes(colour=zj)) +
  ylab("avAttLower statistic") +
  xlab("ego score z_i") + 
  scale_colour_hue(name="alter score z_j")
ggsave("avSimL.png", path = "images/influence plots", width = 6, height = 3)

ggplot(data=df4, aes(x=zi, y=s)) + 
  geom_line(aes(colour=zj)) +
  ylab("avAttHigher+Lower statistic") +
  xlab("ego score z_i") + 
  scale_colour_hue(name="alter score z_j")
ggsave("avSimHL.png", path = "images/influence plots", width = 6, height = 3)

```

## avSim
![](images/influence plots/avSim.png)

avSim draws ego to the behavior of alters.

## avAttHigher
![](images/influence plots/avSimH.png)

avAttHigher is a one-sided version of avSim. It refers to the influence from alters that score higher than ego. Ego is pulled up by alters that score higher than himself. 

## avAttLower
![](images/influence plots/avSimL.png)

avAttHigher is a one-sided version of avSim. It refers to the influence from alters that score lower than ego. Ego is pulled down by alters that score lower than himself. 


## avAttHigher+Lower
![](images/influence plots/avSimHL.png)

avAttHigher and avAttLower even each other out; and equal avSim (assuming identical parameter values).

# {-}

