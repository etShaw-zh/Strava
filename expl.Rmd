---
title: "RSiena: Exploratory analyses "
date: "Last compiled on `r format(Sys.time(), '%B, %Y')`"
bibliography: references.bib
output:
  html_document:
    css: tweaks.css
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 2
    code_folding: show
    code_download: yes
---

```{r, globalsettings, echo=FALSE, warning=FALSE}
library(knitr)
library(RSiena)
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test2"))
options(width = 100)
rgl::setupKnitr()

colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x) }

```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```



---

Let's estimate the Stochastic Actor-Oriented Model (SAOM) implemented in R as the Simulation Investigation for Empirical Network Analysis (R-SIENA), developed by @snijders2010.

----

<br>

# Clubs

<br> 

## Preparation

Clean the working environment.

```{r, attr.output='style="max-height: 200px;"'}
# clean the working environment 
rm (list = ls( ))
```

<br> 

We will:

1. Get our data and create an R-SIENA object
2. Inspect our data
3. Define our effects
4. Define our algorithm
5. And estimate the SAOM

Below, we will follow these steps for club 1 (N=30). We will explore the SAOM for 3 clubs in order to find the best model (see [Results](#result)). We will subsequently test if this model also fits the data of the remaining two clubs (and afterwards with the [ego-centered networks](#egos)).


----

<br>

## Step 1: Data

We start off by reading in the data, specifying variable roles for the RSiena object, and creating an RSiena object. We use the clubdata.RData object.

- For now we take as our (explanatory) network variable the Kudo-network in which awarding/receiving *at least* 1 Kudo constitutes an *i,j* tie. Later on we will estimate a model in which awarding/receiving more than 1 Kudo constitutes the presence of a tie. Ultimately, we may want to construct an ordered network-variable, in which awarding/receiving more than 1 Kudo is a sub-network of the network in which awarding/reciving 1 Kudo counts as a tie. 

- Our (dependent) behavioral variable is running frequency (in times per week; ranging from 0 to >7 times per week), and running volume (in minutes per month; with 8 equally populated categories).

- We included activity in other sports (e.g., cycling and swimming) as a time-varying covariate.

- And we also included gender (men vs. women and others), and winter as constant and varying covariates, respectively.

- And friendships as a constant dyadic covariate, as this will probably determine who gives Kudos to whom.


```{r}
load("clubdata.Rdata") # load (raw) club list
club <- clubdata[[4]] # grab club 

# specify variable roles for RSiena object
kudonet <- sienaDependent(club$kudo)
kudonet2 <- sienaDependent(club$kudo2) 

freq_run <- sienaDependent(club$freq_run, type= "behavior")

time_run <- sienaDependent(club$time_run, type = "behavior")

freq_other <- varCovar(club$freq_other[,,])
time_other <- varCovar(club$time_other[,,])

gender <- NA 
gender <- ifelse(club$male == 1, 1, gender)
gender <- ifelse(club$female == 1, 2, gender)
gender <- ifelse(club$other == 1, 2, gender)
gender <- coCovar(gender)

winter <- varCovar(club$winter)

friendship <- coDyadCovar(club$friendship)

#create rsiena data object
mydata <- sienaDataCreate(kudonet, freq_run, time_run, freq_other, time_other, gender, winter, friendship)
```

<!--- 

After the estimation procedure, just edit the number within the double brackets [[x]] to grab another club.

---> 

----

<br>

## Step 2: Inspect data
```{r eval=F}
print01Report(mydata)
```

A text file is printed in the working directory.

![](files/Siena.txt){#id .class width=100% height=200px}

----

<br>

## Step 3: Define effects
We are going to define our 'myeff' object containing the model parameters. A list of all available effects for the given object can be displayed in browser by requesting effectsDocumentation(myeff). See @rsienamanual for a substantial and mathematical description of all effects.

We include:

1. [structural network effects](#str)
2. [network selection effects](#sel)
3. [network influence effects](#inf)
4. and [covariate effects](#co) on network and behavior 


```{r echo=T, results='hide'}
myeff <- getEffects(mydata)
effectsDocumentation(myeff)
```


<br>

### Structural network effects {#str}
First, we are going to include structural network effects, guided by recommendations of @snijderspres: outdegree, reciprocity, and transitivity (GWESP).
We also add degree-related effects: indegree-popularity and outdegree-activity (square-root versions).

```{r echo=T, results='hide'}
myeff1 <- includeEffects(myeff, gwespFF, name = "kudonet") 
myeff1 <- includeEffects(myeff1, outActSqrt, inPopSqrt, name = "kudonet")
```

<br>

### Selection effects {#sel}
Second, we include selection effects with respect to behavior. We estimate the effect of actors' (ego and alter) behavior, and the similarity between the two (homophily) on tie formation. 

We start with effects of frequency on tie formation.


```{r echo=T, results='hide'}
myeff2 <- includeEffects(myeff1, egoX, altX, simX, name="kudonet", interaction1 = "freq_run")
```

<br>

### Influence effects {#inf}
We included two influence effects to test our hypotheses on the influence of social support and social comparison processes respectively:

1. The reciprocated degree effect on behavior.
This tests the social support explanation: the more reciprocated Kudo-ties (i.e. "strong tie" friendships), the greater the probability of increasing the behavior. 

2. The average reciprocated alter effect.
This test the social comparison explanation: the tendency to assimilate to the average behavior of reciprocated alters (i.e. "strong tie" friends).

**Note** that in the average reciprocated alter effect the expected positive effect of upward comparison and the negative effect of downward comparison are assumed to even each other out. In our case this assumption is rather poor, as upward and downward comparison processes may have independent effects on egoâ€™s tendency to increase their behavior. Therefore, we may want to find a more suitable effect. 

```{r echo=T, results='hide'}
myeff3 <- includeEffects(myeff2, recipDeg, name = "freq_run", interaction1 = "kudonet") 
myeff3 <- includeEffects(myeff3, recipDeg, name = "time_run", interaction1 = "kudonet")

myeff3 <- includeEffects(myeff3, avRecAlt, name = "freq_run", interaction1 = "kudonet") 
myeff3 <- includeEffects(myeff3, avRecAlt, name = "time_run", interaction1 = "kudonet") 
```

<br>


<!--- 

An extra theoretical thought: we may want to condition the influence effects on current behavior,
with an interaction between influence effects and the quadratic shape effect:

myeff3 <- includeEffects(myeff3, quad, recipDeg, name = "freq_run", interaction1 = c("", "kudonet"))
myeff3 <- includeInteraction(myeff3, quad, avRecAlt, name="freq_run", interaction1=c("","kudonet"))

---> 

<br>

### Covariate effects {#co}

And last we add effects on tie and behavior changes of other variables:

- the interdependence between frequency and volume
- the interdependence between running and other sports
- winter on behavior
- gender on tie selection and behavior

Note: we also estimated models with an effect of the constant dyadic covariate Friendship on Kudo ties, which was highly significant. However, this effect seemed to be collinear with structural network effect, meaning that it explained similar tie formation structures. Therefore we excluded Friendship. 

```{r echo=T, results='hide'}
myeff3 <- includeEffects(myeff3, effFrom, name = "time_run", interaction1 = "freq_run")
myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "time_run")

myeff3 <- includeEffects(myeff3, effFrom, name = "time_run", interaction1 = "time_other")
myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "freq_other")

myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "winter")
myeff3 <- includeEffects(myeff3, effFrom, name = "time_run", interaction1 = "winter")


myeff3 <- includeEffects( myeff3, egoX, altX, sameX, name="kudonet", interaction1 = "gender" )
myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "gender")
myeff3 <- includeEffects(myeff3, effFrom, name = "time_run", interaction1 = "gender")
```


<br>

Now check which effects are included in the myeff object.

```{r class.source = 'fold-hide' }
options(width = 100) # ignore (this is for the html formatting)
print(myeff3)
```


Seems allright!

----

<br>

## Step 4: Define algorithm

```{r class.source = 'fold-hide'  }
myalgorithm <- sienaAlgorithmCreate(projname = "test")
```

----

<br>

## Step 5: Estimate the model

Let's estimate the SAOM.

We will save the results in a html-table using the siena.table()-function, in the 'files'-folder in our working directory. We will run the model as many times as necessary, until we reach a convergence ratio of < .30, which we find acceptable for exploratory analyses.


```{r eval= F}
try <- 1

ansM1 <- siena07(myalgorithm, data = mydata, effects = myeff3)

siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "last.html", sep = ""))

# the following script lets the model re-run until we get a good convergence ratio
while (TRUE){
  
  if(ansM1$tconv.max > .30){
    try <- try + 1
    print(paste("Try:", try, sep=" "))
    ansM1 <- siena07( myalgorithm, data = mydata, effects = myeff3, prevAns= ansM1)
    siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM1_", try, ".html", sep=""))
    
  }else{
    siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "final", ".html", sep=""))
    print(paste("Reached convergence ratio of ", ansM1$tconv.max, sep = ""))
    break
  }
}
```

<!--- 

#RF in the files folder sub-folders are made for each club, with preliminary results (final.html) in the 'prelim' folders
We show the results in the prelim2 folder: in these models we added friendship as a dyadic covariate effect on Kudo ties. 

---> 

----

<br>


## Step 6: Results {#result}

We present the SAOM results for all clubs.

### {.tabset .tabset-fade}

#### Club 1
```{r, echo=F}
htmltools::includeHTML("files/clubs results/club1.html")
```

#### Club 2
```{r, echo=F}
htmltools::includeHTML("files/clubs results/club2.html")
```

#### Club 3
```{r, echo=F}
htmltools::includeHTML("files/clubs results/club3.html")
```

#### Club 4
```{r, echo=F}
htmltools::includeHTML("files/clubs results/club4.html")
```

Note that we excluded gender effects on tie formation and behavior change, as they were non-significant and caused convergence issues (probably because of small N). Also note the high rate parameters!

#### Club 5
```{r, echo=F}
htmltools::includeHTML("files/clubs results/club5.html")
```

### {-}

- We see a marginal reciprocated degree effect on running volume (club 1) and running frequency (club 2).

- We see positive average reciprocated alter effect on running frequency and volume (club 5). Previously (in a model without friendship effect and behavioral similarity effect on ties), we also found these effects for Club 3, but these effects are now non-significant.

<!--- 

#RF: I think friendship may be left out... it seems to explain away structural effects such as reciprocity and transitivity.
---> 


Thus, in three clubs we find influence effects (indicating support and comparison). These effects are observed even after controlling for selection and structural network effects. 



----

## Ordered network variable {#lvl2}

In the estimated SAOM the reciprocation of at least 1 Kudo constituted the presence of a tie. In the following we will estimate the same SAOM but now with the ordered kudo-network, with 2 levels. We predict to find more substantial effects in the second-order network. 

<!--- 

replace the kudonet with kudonet2
---> 


----

<br>

# Egos {#egos}

<br>

## Preparation

Clean the working environment.

```{r, attr.output='style="max-height: 200px;"'}
# clean the working environment 
rm (list = ls( ))
```
<br>

We will check if the model also fits the ego-centered data. We start with the 1.5 degree network of one ego. Later on we can estimate multiple models for the respective egos, or do a multi-group analysis.

We start off with ego 3 (N=28). Descriptive statistics revealed that this ego-centered network was appropriate for R-SIENA (i.e. appropriate Jaccard indices, sufficient degrees/density).

<br>

## Step 1: Data

Reading the data, specifying variable roles for the RSiena object, creating an RSiena object.

```{r}
load("egodata1.5.Rdata") # load (raw) 1.5 degree ego-centered data list
ego <- egodata1.5[[3]] # grab club 

# specify variable roles for RSiena object

kudonet <- sienaDependent(ego$kudo[,, 1:11])
kudonet2 <- sienaDependent(ego$kudo2[,, 1:11]) 

freq_run <- sienaDependent(ego$freq_run[,, 1:11], type= "behavior")
time_run <- sienaDependent(ego$time_run[,, 1:11], type = "behavior")

freq_other <- varCovar(ego$freq_other[,,1:11])
time_other <- varCovar(ego$time_other[,,1:11])

gender <- NA 
gender <- ifelse(ego$male == 1, 1, gender)
gender <- ifelse(ego$female == 1, 2, gender)
gender <- ifelse(ego$other == 1, 2, gender)
gender <- coCovar(gender)

winter <- varCovar(ego$winter[,1:11])

#create rsiena data object
mydata <- sienaDataCreate(kudonet, freq_run, time_run, freq_other, time_other, gender, winter)
```

----

<br>

## Step 2: Inspect data
```{r eval=F}
print01Report(mydata)
```

![](files/ego3_1.5.txt){#id .class width=100% height=200px}

----

<br>

## Step 3: Define effects
We include the same effects as in the clubs (but we exclude friendship as a covariate effect.):

1. [structural network effects](#str2)
2. [network selection effects](#sel2)
3. [network influence effects](#inf2)
4. and [covariate effects](#co2) on network and behavior 


```{r echo=T, results='hide'}
myeff <- getEffects(mydata)
effectsDocumentation(myeff)
```

<br>

### Structural network effects {#str2}

```{r echo=T, results='hide'}
myeff1 <- includeEffects(myeff, gwespFF, name = "kudonet") 
myeff1 <- includeEffects(myeff1, outActSqrt, inPopSqrt, name = "kudonet")
```

<br>

### Selection effects {#sel2}

```{r echo=T, results='hide'}
myeff2 <- includeEffects(myeff1, egoX, altX, simX, name="kudonet", interaction1 = "freq_run")
```

<br>

### Influence effects {#inf2}

```{r echo=T, results='hide'}
myeff3 <- includeEffects(myeff2, recipDeg, name = "freq_run", interaction1 = "kudonet") 
myeff3 <- includeEffects(myeff3, recipDeg, name = "time_run", interaction1 = "kudonet")

myeff3 <- includeEffects(myeff3, avRecAlt, name = "freq_run", interaction1 = "kudonet") 
myeff3 <- includeEffects(myeff3, avRecAlt, name = "time_run", interaction1 = "kudonet") 
```

<br>

### Covariate effects {#co2}

```{r echo=T, results='hide'}

myeff3 <- includeEffects(myeff3, effFrom, name = "time_run", interaction1 = "freq_run")
myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "time_run")

myeff3 <- includeEffects(myeff3, effFrom, name = "time_run", interaction1 = "time_other")
myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "freq_other")

myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "winter")
myeff3 <- includeEffects(myeff3, effFrom, name = "time_run", interaction1 = "winter")


myeff3 <- includeEffects( myeff3, egoX, altX, sameX, name="kudonet", interaction1 = "gender" )
myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "gender")
myeff3 <- includeEffects(myeff3, effFrom, name = "time_run", interaction1 = "gender")
```


<br>

Now check the effects

```{r class.source = 'fold-hide' }
options(width = 100) # ignore (this is for the html formatting)
print(myeff3)
```

----

<br>

## Step 4: Define algorithm

```{r class.source = 'fold-hide'  }
myalgorithm <- sienaAlgorithmCreate(projname = "test")
```

----

<br>

## Step 5: Estimate the model

```{r eval= F}
try <- 1

ansM1 <- siena07(myalgorithm, data = mydata, effects = myeff3)

siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "last.html", sep = ""))

# the following script lets the model re-run until we get a good convergence ratio
while (TRUE){
  
  if(ansM1$tconv.max > .30){
    try <- try + 1
    print(paste("Try:", try, sep=" "))
    ansM1 <- siena07( myalgorithm, data = mydata, effects = myeff3, prevAns= ansM1)
    siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM1_", try, ".html", sep=""))
    
  }else{
    siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "final", ".html", sep=""))
    print(paste("Reached convergence ratio of ", ansM1$tconv.max, sep = ""))
    break
  }
}
```

<!--- 

#RF: I left out W12 as there was no data of W12...
---> 


<br>

## Step 6: Results

```{r, echo=F}
htmltools::includeHTML("files/ansego3.html")
```


----

### References
