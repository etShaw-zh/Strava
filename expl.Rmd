---
title: "RSiena: Exploratory analyses "
date: "18-1-2021"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    code_folding: show
    code_download: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

---

We are going to explore the best-fitting model parameters. We are going to start small...

----

<br>

# Preparation

Clean the working environment and set the working directory.

```{r, attr.output='style="max-height: 200px;"'}
# clean the working environment 
rm (list = ls( ))

# set the working directory
setwd("C:\\Users\\u244147\\Documents\\GitHub\\Stravajournal") 
```

We will make a new RSiena object:

* Dependent variables: Kudos, running frequency
* Constant covariate: friendships (dyadic), gender
* Starting with one club (N=30)

----

<br>

# Step 1: Data

We start with fewer waves...

```{r}
#load("clubdata_rsiena.Rdata") # load club list
#mydata <- clubdata_rsiena[[1]] # grab rsiena object club 1
#library(RSiena) #and load package

# for fewer waves
load("clubdata.Rdata") # load (raw) club list
club <- clubdata[[1]] # grab club 

# specify variable roles for RSiena object
kudonet <- sienaDependent(club$kudo[,, c(1, 6, 12)])
freq_run <- sienaDependent(club$freq_run[,, c(1, 6, 12)], type= "behavior")
#time_run <- sienaDependent(club$time_run[,, c(1, 6, 12)], type= "behavior")

friendship <- coDyadCovar(club$friendship)

gender <- NA #we dichotomize gender as binary (men vs. women and other)
gender <- ifelse(club$male == 1, 1, gender)
gender <- ifelse(club$female == 1, 2, gender)
gender <- ifelse(club$other == 1, 2, gender)
gender <- coCovar(gender)

winter <- varCovar(club$winter[, c(1, 6, 12)])

#create rsiena data object
mydata <- sienaDataCreate(kudonet, freq_run, friendship, gender, winter)
#mydata <- sienaDataCreate(kudonet, time_run, freq_run, friendship, gender, winter)
```

----

<br>

# Step 2: Inspect data
```{r eval=T}
print01Report(mydata)
```

A text file is printed in the working directory.

![](files/Siena.txt)

----

<br>

# Step 3: Define effects
We are going to define our 'myeff' object containing the model parameters. A list of all available effects for the given object can be displayed in browser by requesting effectsDocumentation(myeff).

```{r echo=T, results='hide'}
myeff <- getEffects(mydata)
#effectsDocumentation(myeff)
```

First, we are going to include structural network effects, guided by recommendations of Snijders (see [here](http://www.stats.ox.ac.uk/~snijders/siena/Net_longi7_A_s.pdf) and [here](http://www.stats.ox.ac.uk/~snijders/siena/Siena_ModelSpec_s.pdf)). And we also include covariate effects of gender (monadic and dyadic)

```{r echo=T, results='hide'}
# Structural effects
myeff1 <- includeEffects(myeff, gwespFF, #triadic
                         inPop, outAct, name = "kudonet") #degree-related

myeff1 <- includeInteraction(myeff1, recip, gwespFF, parameter = 69) #gwesp x reciprocity

myeff1 <- includeEffects(myeff1, egoX, altX, sameX, name = "kudonet", interaction1 = "gender")

```

Second, we include selection-effects (i.e. who sends/receives Kudos, and between whom are Kudos exchanged?). We include effects reflecting homophily tendencies in Kudo exchanging based on (a) gender and (b) time spent on running / frequency of running. 

For the selection-on-behavior-part, we may want to try the 'five-parameter' (quadratic) model (see [here, slide 23](http://www.stats.ox.ac.uk/~snijders/siena/Siena_ModelSpec_s.pdf)).

But for now, we use the simpler model (i.e., egoX, altX, simX).

```{r echo=T, results='hide'}
# attribute effects and homophily tendencies in Kudo relations with respect to gender
myeff2 <- includeEffects( myeff1, egoX, altX, sameX, name="kudonet", interaction1 = "gender" )

# attribute effects and homophily tendencies in Kudo relations with respect to activity level
myeff2 <- includeEffects(myeff2, egoX, altX, simX, name="kudonet", interaction1 = "freq_run")

# the full quadratic model: 
#myeff2 <- includeEffects(myeff1, diffSqX, altSqX, altX, egoX, egoSqX, interaction1 = "freq_run")
```

Third, in the behavioral model, we include social influence effects of (a) Kudos (*social support*), and (b) alters' activity level ('contagion', *social comparison*). 


```{r echo=T, results='hide'}
# Kudo-indegree effect on running  
myeff3 <- includeEffects(myeff2, indeg, name = "freq_run", interaction1 = "kudonet") #popularity-related tendency (i.e. "support")

# we may want to include the square root version! How to specify?
# also: we may want to condition the popularity-related tendency on current behavior!

myeff3 <- includeEffects(myeff3, avAlt, name = "freq_run", interaction1 = "kudonet") #behavior-related average similarity

myeff3 <- includeInteraction(myeff3, quad, effFrom, name = "freq_run", interaction1 = c("", "winter")) #also, we condition the shape effect on winter, to check for seasonal effects.

# additional interactions:
myeff3 <- includeInteraction(myeff3, quad, avAlt, name = "freq_run", interaction1 = c("", "kudonet"))
#check whether social influence ("contagion") is conditional on actors current activity level (see RSiena manual, p.57).

```

And last we add effects on behavior of other variables
```{r echo=T, results='hide'}
myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "gender")
myeff3 <- includeEffects(myeff3, effFrom, name = "freq_run", interaction1 = "winter")
```


**Note**: as of yet, I am not sure whether to include the total similarity or the total alter effect (or the average-effect variants). This choice has to be made both on theoretical grounds and on the basis of statistical significance. For now we go with the average alter effect. 

<br>

Now check which effects are included in the myeff object.

```{r class.source = 'fold-hide' }
options(width = 100) # ignore (this is for the html formatting)
print(myeff3)
```

## {-}

Seems allright!

----

<br>

# Step 4: Define algorithm

```{r }
myalgorithm <- sienaAlgorithmCreate(projname = "test")
```

----

<br>

# Step 5: Estimate the model

Let's estimate the model.

We will save the results in a html-table using the siena.table()-function, in the 'files'-folder in our working directory (make sure to create one manually). We will run the model as many times as necessary, until we get an acceptable convergence ratio (< .25).


```{r eval=F }

try <- 1

ansM1 <- siena07(myalgorithm, data = mydata, effects = myeff3)
siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "last.html", sep = ""))

# the following script lets the model re-run until we get a good convergence ratio
while (TRUE){
  
  if(ansM1$tconv.max > 0.25){
    try <- try + 1
    print(paste("Try:", try, sep=" "))
    ansM1 <- siena07( myalgorithm, data = mydata, effects = myeff1, prevAns= ansM1)
    siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM1_", try, ".html", sep=""))
    
  }else{
    siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM1_", try, ".html", sep=""))
    print(paste("Reached convergence ratio of ", ansM1$tconv.max, sep = ""))
    break
  }
}
```

----

<br>


# Step 6: Results

Down below the results are shown for club 2 (N = 62), club 3 (N = 165) and club 5 (N = 77). All models converged well. For clubs with fewer members (e.g., club 1 (N = 30)), we may want to use more waves to get good convergence. 

## {.tabset .tabset-fade} 

### Club 2
```{r, echo=FALSE}
htmltools::includeHTML("files/Club2_ansM1_1.html")
```

### Club 3
```{r, echo=FALSE}
htmltools::includeHTML("files/Club3_ansM1_1.html")
```

### Club 5
```{r, echo=FALSE}
htmltools::includeHTML("files/Club5_ansM1_1.html")
```


## {-}

----

