---
title: "RSiena: Exploratory analyses "
date: "18-1-2021"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    code_folding: show
    code_download: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

---

We are going to explore the best-fitting model parameters. We are going to start small, focusing on one club, and on just three time-points.

----

<br>

# Preparation

Clean the working environment and set the working directory.

```{r, attr.output='style="max-height: 200px;"'}
# clean the working environment 
rm (list = ls( ))

# set the working directory
setwd("C:\\Users\\u244147\\Documents\\dissertatie\\Strava data\\clubs") 
```

We will make a new RSiena object:

* Dependent variables: Kudos, running volume, running frequency
* Constant covariate: friendships (dyadic), gender
* Starting with one club (N=30)
* And using data on three months: t1, t6, t12

----

<br>

# Step 1: Data

```{r}
load("clubdata.Rdata") # load (raw) club list
club <- clubdata[[1]] # grab club 1

# specify variable roles for RSiena object
library(RSiena)

kudonet <- sienaDependent(club$kudo[,, c(1, 6, 12)])
time_run <- sienaDependent(club$time_run[,, c(1, 6, 12)], type= "behavior")
time_other <- sienaDependent(club$time_other[,, c(1, 6, 12)], type= "behavior")

friendship <- coDyadCovar(club$friendship)

gender <- NA
gender <- ifelse(club$male == 1, 1, gender)
gender <- ifelse(club$female == 1, 2, gender)
gender <- ifelse(club$other == 1, 3, gender)
gender <- coCovar(gender)

mydata <- sienaDataCreate(kudonet, time_run, time_other, friendship, gender)
```

----

<br>

# Step 2: Inspect data
```{r eval=T}
print01Report(mydata)
```

A text file is printed in the working directory.

![](files/Siena_test.txt)

----

<br>

# Step 3: Define effects
We are going to define our 'myeff' object containing the model parameters. A list of all available effects for the given object can be displayed in browser by requesting effectsDocumentation(myeff).

```{r echo=T, results='hide'}
myeff <- getEffects(mydata)
#effectsDocumentation(myeff)
```

First, we are going to include structural network effects.

```{r echo=T, results='hide'}
# Structural effects
myeff1 <- includeEffects(myeff, inPop, transTrip, transRecTrip, name="kudonet")
```

Second, we include selection-effects (i.e. who sends/receives Kudos, and between whom are Kudos exchanged?). We include effects reflecting homophily tendencies in Kudo exchanging based on (a) gender and (b) time spent on running / frequency of running. 

```{r echo=T, results='hide'}
# Homophily tendencies in Kudo relations with respect to gender
myeff2 <- includeEffects( myeff1, sameX, name="kudonet", interaction1 = "gender" )

# Homophily tendencies in Kudo relations with respect to activity level
myeff2 <- includeEffects(myeff2, egoX, altX, absDiffX, name="kudonet", interaction1 = "time_run")
myeff2 <- includeEffects(myeff2, egoX, altX, absDiffX, name="kudonet", interaction1 = "time_other")
```

Third, in the behavioral model, we include social influence effects of (a) Kudos (*social support*), and (b) alters' activity level ('contagion', *social comparison*).

```{r echo=T, results='hide'}
# Kudo-indegree effect on running  
myeff3 <- includeEffects(myeff2, indeg, outdeg, name = "time_run", interaction1 = "kudonet") # we also include outdegree effect
myeff3 <- includeEffects(myeff3, indeg, outdeg, name = "time_other", interaction1 = "kudonet")

# Subset this model
myeff0 <- myeff3

# Total alter effect on running 
myeff3a <- includeEffects(myeff0, totAlt, name = "time_run", interaction1 = "kudonet")
myeff3a <- includeEffects(myeff3a, totAlt, name = "time_other", interaction1 = "kudonet")

# Let's also try the total similarity effect 
myeff3b <- includeEffects(myeff0, totSim, name = "time_run", interaction1 = "kudonet")
myeff3b <- includeEffects(myeff3b, totSim, name = "time_other", interaction1 = "kudonet")
myeff3b <- includeEffects(myeff3b, totSim, name = "freq_run", interaction1 = "kudonet")

# And why not also try the total similarity x reciprocity effect
myeff3c <- includeEffects(myeff0, totSimRecip, name = "time_run", interaction1 = "kudonet")
myeff3c <- includeEffects(myeff3c, totSimRecip, name = "time_other", interaction1 = "kudonet")
```

**Note**: as of yet, I am not sure whether to include the total similarity or the total alter effect (or the average-effect variants). This choice has to be made both on theoretical grounds and on the basis of statistical significance. 

<br>

Now check which effects are included in the myeff object.

## {.tabset .tabset-fade} 

### Structural effects

```{r class.source = 'fold-hide'}
options(width = 100) # ignore (this is for the html formatting)
print(myeff1)
```

### + Selection 

```{r class.source = 'fold-hide' }
options(width = 100) # ignore (this is for the html formatting)
print(myeff2)
```

### + Influence (total model): total alter

```{r class.source = 'fold-hide' }
options(width = 100) # ignore (this is for the html formatting)
print(myeff3a)
```

### + Influence (total model): total similarity

```{r class.source = 'fold-hide' }
options(width = 100) # ignore (this is for the html formatting)
print(myeff3b)
```

### + Influence (total model): total similarity x reciprocity

```{r class.source = 'fold-hide' }
options(width = 100) # ignore (this is for the html formatting)
print(myeff3c)
```

## {-}

Seems allright!

----

<br>

# Step 4: Define algorithm

```{r }
myalgorithm <- sienaAlgorithmCreate(projname = "test")
```

----

<br>

# Step 5: Estimate the model

Let's estimate the models, in the following order:

1. Only the structural effects.
2. Include the selection effects.
3. Include the influence effects (the total model; the three variants)

We will save the results in a html-table using the siena.table()-function, in the 'files'-folder in our working directory (make sure to create one manually). We will run the model as many times as necessary, until we get an acceptable convergence ratio (< .25).

## {.tabset .tabset-fade} 

### Model 1

```{r eval=FALSE}
# Only the structural effects (myeff1)

try <- 1
iteration <- 1

ansM1 <- siena07(myalgorithm, data = mydata, effects = myeff1)
siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "last.html", sep = ""))

# the following script lets the model re-run until we get a good convergence ratio
while (TRUE){
  
  if(ansM1$tconv.max > 0.25){
    try <- try + 1
    print(paste("Try:", try, sep=" "))
    ansM1 <- siena07( myalgorithm, data = mydata, effects = myeff1, prevAns= ansM1)
    siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM1_", iteration, ".html", sep=""))
    
  }else{
    siena.table(ansM1, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM1_", iteration, ".html", sep=""))
    print(paste("Reached convergence ratio of ", ansM1$tconv.max, sep = ""))
    break
  }
}
```

### Model 2

```{r eval=FALSE}
# Include selection effects (myeff2)

try <- 1
iteration <- 1

ansM2 <- siena07(myalgorithm, data = mydata, effects = myeff2)
siena.table(ansM2, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "last.html", sep = ""))

# the following script lets the model re-run until we get a good convergence ratio
while (TRUE){
  
  if(ansM2$tconv.max > 0.25){
    try <- try + 1
    print(paste("Try:", try, sep=" "))
    ansM2 <- siena07( myalgorithm, data = mydata, effects = myeff2, prevAns= ansM2)
    siena.table(ansM2, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM2_", iteration, ".html", sep=""))
    
  }else{
    siena.table(ansM2, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM2_", iteration, ".html", sep=""))
    print(paste("Reached convergence ratio of ", ansM2$tconv.max, sep = ""))
    break
  }
}
```

### Model 3a

```{r eval=FALSE}
# Include influence effects (myeff3a: totAlt)

try <- 1
iteration <- 1

ansM3a <- siena07(myalgorithm, data = mydata, effects = myeff3a)
siena.table(ansM3a, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "last.html", sep = ""))

# the following script lets the model re-run until we get a good convergence ratio
while (TRUE){
  
  if(ansM3a$tconv.max > 0.25){
    try <- try + 1
    print(paste("Try:", try, sep=" "))
    ansM3a <- siena07( myalgorithm, data = mydata, effects = myeff3a, prevAns= ansM3a)
    siena.table(ansM3a, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM3a_", iteration, ".html", sep=""))
    
  }else{
    siena.table(ansM3a, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM3a_", iteration, ".html", sep=""))
    print(paste("Reached convergence ratio of ", ansM3a$tconv.max, sep = ""))
    break
  }
}
```

### Model 3b

```{r eval=FALSE}
# Include influence effects (myeff3b: totSim)

try <- 1
iteration <- 1

ansM3b <- siena07(myalgorithm, data = mydata, effects = myeff3b)
siena.table(ansM3b, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "last.html", sep = ""))

# the following script lets the model re-run until we get a good convergence ratio
while (TRUE){
  
  if(ansM3b$tconv.max > 0.25){
    try <- try + 1
    print(paste("Try:", try, sep=" "))
    ansM3b <- siena07( myalgorithm, data = mydata, effects = myeff3b, prevAns= ansM3b)
    siena.table(ansM3b, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM3b_", iteration, ".html", sep=""))
    
  }else{
    siena.table(ansM3b, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM3b_", iteration, ".html", sep=""))
    print(paste("Reached convergence ratio of ", ansM3b$tconv.max, sep = ""))
    break
  }
}
```

### Model 3c

```{r eval=FALSE}
# Include influence effects (myeff3c: totSimRecip)

try <- 1
iteration <- 1

ansM3c <- siena07(myalgorithm, data = mydata, effects = myeff3c)
siena.table(ansM3c, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "last.html", sep = ""))

# the following script lets the model re-run until we get a good convergence ratio
while (TRUE){
  
  if(ansM3c$tconv.max > 0.25){
    try <- try + 1
    print(paste("Try:", try, sep=" "))
    ansM3c <- siena07( myalgorithm, data = mydata, effects = myeff3c, prevAns= ansM3c)
    siena.table(ansM3c, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM3c_", iteration, ".html", sep=""))
    
  }else{
    siena.table(ansM3c, type="html", tstat=T, d=2, sig=T, file = paste("files", "/", "ansM3c_", iteration, ".html", sep=""))
    print(paste("Reached convergence ratio of ", ansM3c$tconv.max, sep = ""))
    break
  }
}
```

## {-}

----

<br>

# Results
Now let's have a look at the results.

## {.tabset .tabset-fade} 

### Model 1
```{r, echo=FALSE}
htmltools::includeHTML("files/ansM1_1.html")
```

### Model 2
```{r, echo=FALSE}
htmltools::includeHTML("files/ansM2_1.html")
```

### Model 3a
```{r, echo=FALSE}
htmltools::includeHTML("files/ansM3a_1.html")
```

### Model 3b
```{r, echo=FALSE}
htmltools::includeHTML("files/ansM3b_1.html")
```

### Model 3c
```{r, echo=FALSE}
htmltools::includeHTML("files/ansM3c_1.html")
```

## {-}

<br> 


----