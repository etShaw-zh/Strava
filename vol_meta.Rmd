---
title: "Meta-analysis"
date: "Last compiled on `r format(Sys.time(), '%B, %Y')`"
bibliography: references.bib
output:
  html_document:
    css: tweaks.css
    toc: no
    toc_float: no
    collapsed: false
    number_sections: false
    toc_depth: 1
    code_folding: show
    code_download: yes
---

```{r, globalsettings, echo=FALSE, warning=FALSE}
library(knitr)
library(RSiena)
library(ggplot2)
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test2"))
options(width = 100)
rgl::setupKnitr()

colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x) }

```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```


----

#  Meta-analysis of running volume models

Down below, we estimate the same models with running volume as the dependent variable:


<br>

Again, to summarize the results over our clubs, we will perform a meta-analysis using a Fisher-type combination of one-tailed p-values.


----

<br>


```{r eval=F}
# clean the working environment 
rm (list = ls( ))

loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}

# large lists, takes a lot of time to load
# in case you don't have enough memory space for all RSiena lists, leave club 3 for now.
club1 <-  loadRData("test/sienaFit/sienaFit_club1.RData")
club2 <-  loadRData("test/sienaFit/sienaFit_club2.RData")
club4 <-  loadRData("test/sienaFit/sienaFit_club4.RData")
club5 <-  loadRData("test/sienaFit/sienaFit_club5.RData")

# we list model 1-6
m1List <- list(club1[[1]], club2[[1]], club4[[1]], club5[[1]])
m2List <- list(club1[[2]], club2[[2]], club4[[2]], club5[[2]])
m3List <- list(club1[[3]], club2[[3]], club4[[3]], club5[[3]])
m4List <- list(club1[[4]], club2[[4]], club4[[4]], club5[[4]])
m5List <- list(club1[[5]], club2[[5]], club4[[5]], club5[[5]])
m6List <- list(club1[[6]], club2[[6]], club4[[6]], club5[[6]])

# remove the excess data, and add club 3's rsiena objects.
#rm(club1,club2,club4,club5)
#club3 <-  loadRData("test/sienaFit/sienaFit_club3.RData")

# add to the lists
#m1List[[5]] <- club3[[1]]
#m2List[[5]] <- club3[[2]]
#m3List[[5]] <- club3[[3]]
#m4List[[5]] <- club3[[4]]
#m5List[[5]] <- club3[[5]]
#m6List[[5]] <- club3[[6]]

```


<br>

# Models {.tabset .tabset-fade} 

We perform the meta-analysis seperately for 6 model specifications.


## Model 1 (indegree)

We extract the parameter estimates and standard errors for the running activity objective functions.

```{r eval = FALSE,  results='hide'}
parameters <- sapply(m1List, function(x){x$theta})
standers <- sapply(m1List, function(x){x$se}) 

(eff.names <-
   m1List[[1]]$effects[m1List[[1]]$effects$include,'effectName']) 
(eff.names <- eff.names)

#combine parameters and std.errors with effect names
rownames(parameters) <- eff.names
rownames(standers) <- eff.names

# print rounded to 3 decimals
round(parameters,3)
round(standers,3)
```

<br>

We use *siena08* to perform Fisher's method for combining independent *p*-values.

<!--- 

@RF: 

- cjplus: test statistic for combination of right one-sided Fisher combination test
- cjplusp: p-value for cjplus
- cjminus: test statistic for combination of left one-sided Fisher combination test
- cjminusp: p-value for cjminus
- df: degrees of freedom

https://search.r-project.org/CRAN/refmans/RSiena/html/siena08.html 

Funnelplot?

---> 

```{r eval = F, results='hide'}
ans8 <- siena08(m1List, bound=100)


#Overalls <- t(sapply(1:40, function(i){c(ans8[[i]]$Tsq, ans8[[i]]$pTsq)}))
#round(Overalls, 3)

efnames <- names(ans8)
efnames <- substring(efnames, 8)
#rownames(Overalls) <- efnames
#round(Overalls, 3)

Fishers <- t(sapply( 1:40,
                     function(i) {
                       c(ans8[[i]]$cjplus, ans8[[i]]$cjminus, ans8[[i]]$cjplusp, ans8[[i]]$cjminusp, 2 * ans8[[i]]$n1 )
                       }))
Fishers <- as.data.frame(Fishers)
rownames(Fishers) <- efnames
names(Fishers) <- c('Fplus', 'Fminus', 'pplus', 'pminus', 'df')
```

<!--- 

@RF: 

hmm.. got some errors

---> 

<br>

And we present the Fisher combinations:
```{r eval=F}
round(Fishers,3)
```

## Model 2 (avAlt)

## Model 3 (avAttHigher)

## Model 4 (avAttLower)

## Model 5 (avAttHigher+Lower)

## Model 6 (avSim)


# {-}

----


